<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeoTek — Inventory Tracker</title>
  <meta name="description" content="Inventory, orders and finance dashboard for a two-owner gadget store (fresh app, no sample data)." />
  <style>
    /* --- Professional light theme, bento grid + flex --- */
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#6b7280; --text:#0f172a;
      --accent:#0ea5a3; --accent-2:#6366f1; --success:#059669; --danger:#dc2626;
      --radius:12px; --shadow: 0 8px 30px rgba(16,24,40,0.06); --gap:14px; --maxw:1200px;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#f8fafc,#f5f7fb);color:var(--text);-webkit-font-smoothing:antialiased}
    .app{max-width:var(--maxw);margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px;box-shadow:var(--shadow)}
    h1{margin:0;font-size:20px}
    .subtitle{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--card);border:none;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 3px 10px rgba(11,20,40,0.04)}
    .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06)}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#0b8f86);color:#fff}
    .layout{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media (max-width:1100px){ .layout{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:700px){ .layout{grid-template-columns:1fr} }
    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);min-height:90px;cursor:pointer;display:flex;flex-direction:column;gap:8px}
    .card.hollow{cursor:default}
    .card .title{font-weight:800}
    .card .meta{color:var(--muted);font-size:13px}
    .card.inline-expanded{background:linear-gradient(180deg,#fff,#fbfdff)}
    .grid-row{display:flex;gap:12px;align-items:center}
    .kpis{display:flex;gap:8px;flex-wrap:wrap}
    .kpi-pill{background:#f3f6f9;padding:8px 10px;border-radius:10px;min-width:90px;text-align:center}
    .muted{color:var(--muted)}
    .small{font-size:13px}
    .status{padding:6px 10px;border-radius:999px;color:#fff;font-weight:700;font-size:12px;display:inline-block}
    .status.pending{background:#0ea5e9}
    .status.shipping{background:#f59e0b}
    .status.delivered{background:#10b981}
    .status.cancelled{background:#ef4444}
    .status.returned{background:#f97316}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid rgba(10,15,30,0.04);text-align:left;font-size:13px}
    .search{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid rgba(10,15,30,0.04);background:#fff}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid rgba(10,15,30,0.06);font-size:14px;width:100%}
    textarea{min-height:80px}
    .modal-root{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;padding:28px;background:rgba(3,6,12,0.45);overflow:auto}
    .modal{width:960px;max-width:100%;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 30px 80px rgba(2,6,23,0.6)}
    .inline-section{margin-top:10px;padding:10px;border-radius:10px;background:#fff;border:1px solid rgba(10,15,30,0.03)}
    .toast{position:fixed;right:20px;bottom:20px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(2,6,23,0.35);display:none}
    .muted-ghost{color:#9aa4b2}
    .btn-sm{padding:6px 8px;border-radius:8px;font-weight:700}
    /* ADDED STYLE FOR CUSTOM CHECKBOX */
    .checkbox-field { display: flex; align-items: center; gap: 8px; }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="GadgetPro Inventory Dashboard">
    <header>
      <div class="brand">
        <div class="logo">NTG</div>
        <div>
          <h1>NeoTek</h1>
          <div class="subtitle">Inventory • Orders • Finance</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn ghost" id="btn-import">Import</button>
        <button class="btn ghost" id="btn-export">Export</button>
        <button class="btn" id="btn-products">Products</button>
        <button class="btn primary" id="btn-sell">Sell Product</button>
      </div>
    </header>

    <main class="layout" id="dashboard">
      <section class="card" id="card-orders" data-type="inline">
        <div>
          <div class="title">Orders Overview</div>
          <div class="meta">Quick summary of order states</div>
        </div>
        <div class="kpis" id="orders-kpis">
          <div class="kpi-pill"><div class="small muted">Received</div><div id="kpi-received">0</div></div>
          <div class="kpi-pill"><div class="small muted">Ongoing</div><div id="kpi-ongoing">0</div></div>
          <div class="kpi-pill"><div class="small muted">Completed</div><div id="kpi-completed">0</div></div>
          <div class="kpi-pill"><div class="small muted">Cancelled</div><div id="kpi-cancelled">0</div></div>
          <div class="kpi-pill"><div class="small muted">Returned</div><div id="kpi-returned">0</div></div>
        </div>
        <div class="meta muted-ghost small">Click to expand recent orders; View All for full orders page</div>
      </section>

      <section class="card" id="card-financials" data-type="inline">
        <div>
          <div class="title">Financials</div>
          <div class="meta">Net profit, total sales, investments</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:center">
          <div>
            <div class="muted small">Total Sales</div>
            <div id="total-sales" style="font-weight:800;color:var(--success)">₹0</div>
          </div>
          <div>
            <div class="muted small">Net Profit</div>
            <div id="net-profit" style="font-weight:800">₹0</div>
          </div>
          <div>
            <div class="muted small">Net Investment</div>
            <div id="net-investment" style="font-weight:800;color:var(--accent-2)">₹0</div>
          </div>
        </div>
        <div class="inline-section" style="margin-top:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div style="font-weight:700" class="small muted">Resettable Metrics (For Withdrawal)</div>
                <button class="btn btn-sm ghost" id="btn-reset-profit">Reset Resettable</button>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                <div>
                    <div class="muted small">Sales</div>
                    <div id="reset-sales" style="font-weight:700">₹0</div>
                </div>
                <div>
                    <div class="muted small">Profit</div>
                    <div id="reset-profit" style="font-weight:700">₹0</div>
                </div>
                <div>
                    <div class="muted small">Investment</div>
                    <div id="reset-investment" style="font-weight:700;color:var(--accent-2)">₹0</div>
                </div>
            </div>
        </div>
        <div style="margin-top:10px; text-align:right"><button class="btn btn-sm primary" id="btn-reset-all-financials">Reset All Financials</button></div>
        <div class="meta muted-ghost small">Click to expand profit breakdown and sales-left-to-regain-investment</div>
      </section>
      
      <section class="card" id="card-investments" data-type="inline">
        <div>
          <div class="title">Investments Overview</div>
          <div class="meta">Total capital and recent contributions</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center">
            <div>
                <div class="muted small">Total Capital</div>
                <div id="invest-total-capital" style="font-weight:800;color:var(--accent-2)">₹0</div>
            </div>
            <div>
                <div class="muted small">Investment Txs</div>
                <div id="invest-tx-count" style="font-weight:800">0</div>
            </div>
        </div>
        <div class="inline-section" style="margin-top:10px">
            <div style="font-weight:700" class="small muted">Latest Investment</div>
            <div id="latest-investment" class="muted small">—</div>
        </div>
        <div class="meta muted-ghost small">Click to view all investment transactions</div>
      </section>
      <section class="card" id="card-products" data-type="modal">
        <div>
          <div class="title">Products</div>
          <div class="meta">Add / edit SKUs, pricing, stock</div>
        </div>
        <div style="margin-top:12px">
          <div class="muted small">Total products</div>
          <div id="prod-count" style="font-weight:800">0</div>
        </div>
        <div class="meta muted-ghost small">Click to open the product management page</div>
      </section>

      <section class="card" id="card-tx" data-type="modal">
        <div>
          <div class="title">Transactions Timeline</div>
          <div class="meta">Investments, purchases, sales, expenses, returns</div>
        </div>
        <div style="margin-top:12px">
          <div class="muted small">Recent</div>
          <div id="tx-preview" class="muted small">—</div>
        </div>
        <div class="meta muted-ghost small">View full timeline to filter and export</div>
      </section>

      <section class="card" id="card-dispatch" data-type="inline">
        <div>
          <div class="title">Orders Status</div>
          <div class="meta">Quick dispatch & status actions</div>
        </div>
        <div id="dispatch-preview" class="inline-section muted small">No orders yet.</div>
        <div class="meta muted-ghost small">Click to expand inline status controls</div>
      </section>

      <section class="card hollow" id="card-io" data-type="inline">
        <div>
          <div class="title">Import & Export</div>
          <div class="meta">Export CSV / Styled report, Import JSON/CSV</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-sm" id="export-csv">Export CSV</button>
          <button class="btn btn-sm" id="export-styled">Export Styled</button>
          <button class="btn btn-sm ghost" id="import-file">Import</button>
        </div>
        <div class="meta muted-ghost small">CSV: data table; Styled: preserves color cues (open in browser/Excel)</div>
      </section>

    </main>

    <div class="modal-root" id="modal-root" role="dialog" aria-hidden="true">
      <div class="modal" id="modal-content" role="document"></div>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>
    <input type="file" id="file-input" accept=".json,.csv" style="display:none" />
  </div>

<script>
    /* Final app JS (fresh app, no sample data). All features described implemented. */
(function(){
  // Helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);
  const nowISO = () => (new Date()).toISOString();
  // Helper to format date into 'YYYY-MM-DD' for date inputs
  const toISODate = (date) => (date instanceof Date ? date : new Date(date)).toISOString().split('T')[0];
  const currency = v => '₹' + Number(v||0).toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 2}); // Changed formatting for better currency display
  const showToast = (msg, t=2200) => {
    const el = $('#toast'); el.textContent = msg; el.style.display = 'block';
    setTimeout(()=> el.style.display = 'none', t);
  };

  // Storage key
  const KEY = 'gadgetpro_final_v1';

  // Fresh initial state (no sample data)
  let state = {
    // Note: 'owners' is kept for legacy compatibility but is unused in calculations now
    owners: [{id:'a',name:'Owner A'},{id:'b',name:'Owner B'}],
    products: [],      // {id, name, sku, price, cost, purchased, stock, sold, returned, cancelled}
    // ADDED shippingCharge to order for Issue 3 fix
    orders: [],        // {id, orderNo, customerName, address, items:[{sku,qty,price}], total, paymentType, status, placedAt, statusHistory, note, shippingCharge}
    // Transaction structure: {id, type, category, name, amount (sale total/expense/investment), ownerSplit:{a,b} (kept for legacy but now all zero), productsAffected:[{sku,qty}], timestamp, note, profit (for sales), orderId (for linking to order)}
    transactions: [],
    resettableFin: {
        totalSales: 0,
        netProfit: 0,
        netInvestment: 0,
        lastReset: nowISO()
    }
  };

  // Persistence
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function load(){
    const raw = localStorage.getItem(KEY);
    if(raw){
      try{ state = JSON.parse(raw); } catch(e){ console.error('Failed to parse store, loading fresh state', e); state = {owners:[{id:'a',name:'Owner A'},{id:'b',name:'Owner B'}],products:[],orders:[],transactions:[],resettableFin:{totalSales:0,netProfit:0,netInvestment:0,lastReset:nowISO()}}; save(); }
    } else {
      save(); // store blank initial
    }
    // Ensure resettableFin exists after load (for older stored states)
    if (!state.resettableFin) {
        state.resettableFin = {totalSales:0,netProfit:0,netInvestment:0,lastReset:nowISO()};
        save();
    }
    // Ensure all orders have a shippingCharge for Issue 3 (default to 0)
    state.orders.forEach(o => {
        if (typeof o.shippingCharge === 'undefined') {
            o.shippingCharge = 0;
        }
    });
    save(); // Save updated structure
  }

  // ---------- Calculations ----------
  function calculateTotalFinancials() {
    // Total Sales: Sum of 'amount' for all 'sale' transactions (Gross Sales). Note: Amount is positive for sales.
    const totalSales = state.transactions.filter(t => t.type === 'sale').reduce((s, t) => s + Math.abs(Number(t.amount||0)), 0);

    // Total Revenue (Sales) Profit: Sum of 'profit' for all 'sale' transactions (Gross Profit from Sales)
    const totalSaleProfit = state.transactions.filter(t => t.type === 'sale').reduce((s, t) => s + Number(t.profit||0), 0);

    // Total Outflows (Purchases + Expenses + Return Losses)
    // Purchases and Expenses are recorded as NEGATIVE amounts in transactions
    const totalOutflows = state.transactions.filter(t => t.type === 'expense' || t.type === 'purchase').reduce((s, t) => s + Number(t.amount||0), 0);

    // Net Profit = Total Sale Profit + Total Outflows (since Outflows are negative, this is a subtraction)
    const netProfit = totalSaleProfit + totalOutflows;

    // Net Investment (Inflows only - recorded as POSITIVE amounts)
    const netInvestment = state.transactions.filter(t => t.type === 'investment').reduce((s, t) => s + Number(t.amount||0), 0);

    return { totalSales, netProfit, netInvestment };
  }

  function calculateResettableFinancials() {
    const lastReset = new Date(state.resettableFin.lastReset);

    // Filter transactions since the last reset
    const recentTx = state.transactions.filter(t => new Date(t.timestamp) >= lastReset);

    // Resettable Sales: Gross sales since last reset. Note: Amount is positive for sales.
    const sales = recentTx.filter(t => t.type === 'sale').reduce((s, t) => s + Math.abs(Number(t.amount||0)), 0);

    // Resettable Sale Profit: Gross profit from sales since last reset
    const saleProfit = recentTx.filter(t => t.type === 'sale').reduce((s, t) => s + Number(t.profit||0), 0);

    // Resettable Outflows: Purchases/Expenses since last reset (negative amounts)
    const outflows = recentTx.filter(t => t.type === 'expense' || t.type === 'purchase').reduce((s, t) => s + Number(t.amount||0), 0);

    // Resettable Profit
    const profit = saleProfit + outflows;

    // Resettable Investment
    const investment = recentTx.filter(t => t.type === 'investment').reduce((s, t) => s + Number(t.amount||0), 0);

    return { sales, profit, investment };
  }


  // ---------- Rendering / UI ----------

  function renderDashboard(){
    // Kpis: orders counts
    const received = state.orders.length;
    const ongoing = state.orders.filter(o => o.status === 'shipping' || o.status === 'pending').length;
    const completed = state.orders.filter(o => o.status === 'delivered' || o.status === 'completed').length;
    const cancelled = state.orders.filter(o => o.status === 'cancelled').length;
    const returned = state.orders.filter(o => o.status === 'returned').length;
    $('#kpi-received').textContent = received;
    $('#kpi-ongoing').textContent = ongoing;
    $('#kpi-completed').textContent = completed;
    $('#kpi-cancelled').textContent = cancelled;
    $('#kpi-returned').textContent = returned;

    // Financials
    const { totalSales, netProfit, netInvestment } = calculateTotalFinancials();

    $('#total-sales').textContent = currency(totalSales);
    $('#net-profit').textContent = currency(netProfit);
    $('#net-investment').textContent = currency(netInvestment);

    // Resettable Financials
    const { sales: resetSales, profit: resetProfit, investment: resetInvestment } = calculateResettableFinancials();

    $('#reset-sales').textContent = currency(resetSales);
    $('#reset-profit').textContent = currency(resetProfit);
    $('#reset-investment').textContent = currency(resetInvestment);

    // Investments Overview
    const investTxs = state.transactions.filter(t => t.type === 'investment').sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
    const totalCapital = investTxs.reduce((s, t) => s + Number(t.amount||0), 0);
    const latestInvest = investTxs[0];

    $('#invest-total-capital').textContent = currency(totalCapital);
    $('#invest-tx-count').textContent = investTxs.length;
    $('#latest-investment').textContent = latestInvest ? `${latestInvest.name} (${currency(latestInvest.amount)}) on ${toISODate(latestInvest.timestamp)}` : 'No recent investment.';


    // Products count
    $('#prod-count').textContent = state.products.length;

    // Transactions preview (last 3)
    const txPreview = state.transactions.slice().sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp)).slice(0,3);
    $('#tx-preview').textContent = txPreview.length ? txPreview.map(t=> `${t.type} ${t.name||''} ${currency(t.amount)}`).join(' • ') : '—';

    // Dispatch preview: show up to 4 ongoing orders
    const dispatchEl = $('#dispatch-preview');
    const ongoingOrders = state.orders.filter(o => o.status === 'shipping' || o.status === 'pending').slice(0,4);
    if(!ongoingOrders.length){ dispatchEl.innerHTML = '<div class="muted small">No ongoing orders.</div>'; }
    else {
      dispatchEl.innerHTML = '';
      ongoingOrders.forEach(o=>{
        const div = document.createElement('div');
        div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='6px';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${escapeHtml(o.orderNo)}</div><div class="muted small">${escapeHtml(o.customerName)}</div>`;
        // Changed quick-change button to quick-action
        const right = document.createElement('div'); right.innerHTML = `<span class="status ${o.status}">${escapeHtml(o.status)}</span> <button class="btn btn-sm" data-id="${o.id}" data-action="quick-action">Action</button>`;
        div.appendChild(left); div.appendChild(right);
        dispatchEl.appendChild(div);
      });
       // Re-attaching event listeners for the new quick-action button
      dispatchEl.querySelectorAll('button[data-action="quick-action"]').forEach(b => {
          b.onclick = () => openOrderQuickActionModal(b.dataset.id);
      });
    }
  }

  // ---------- Utilities ----------
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  /**
   * Reverses the financial and stock effects of a SALE transaction and its associated order.
   * Called when an order is cancelled or returned, or when an order is deleted.
   * @param {object} order - The order object being reversed.
   * @param {string} type - 'returned' or 'cancelled' or 'delete'.
   * @param {number} loss - Optional: shipment loss amount for 'returned' type.
   */
  function reverseSaleEffects(order, type, loss = 0) {
      // 1. Update Product Stock/Stats
      order.items.forEach(it => {
          const p = state.products.find(pp => pp.sku === it.sku);
          if (p) {
              // Decrement sold count
              p.sold = Math.max(0, (Number(p.sold)||0) - Number(it.qty));
              
              if (type === 'returned') {
                  // Restore stock and increment returned count
                  p.returned = (Number(p.returned)||0) + Number(it.qty);
                  p.stock = (Number(p.stock)||0) + Number(it.qty);
              } else if (type === 'cancelled') {
                  // Restore stock and increment cancelled count
                  p.cancelled = (Number(p.cancelled)||0) + Number(it.qty);
                  p.stock = (Number(p.stock)||0) + Number(it.qty);
              }
              // Note: If type is 'delete', only stock is restored and sold is decremented, 
              // but the specific 'returned'/'cancelled' stats are not touched.
          }
      });

      // 2. Reverse Financial Transaction (find the original sale transaction)
      const saleTxIndex = state.transactions.findIndex(t => t.orderId === order.id && t.type === 'sale');

      if (saleTxIndex !== -1) {
          const originalTx = state.transactions[saleTxIndex];

          // --- IMPLEMENTATION: Simple Profit Reversal Expense ---
          const reversalNote = `${type} of ${order.orderNo}. Reversing profit and loss of goods.`;

          // A. Reversal of Goods/Sale Profit Loss: Create an expense for the profit amount (negative)
          if(originalTx.profit > 0 && type !== 'delete'){ // Only create reversal if not deleting the transaction entirely
             state.transactions.push({ 
                id:uid('t'), type:'expense', category: type + ' Profit Reversal', 
                name: order.orderNo, amount: -Math.abs(originalTx.profit), ownerSplit:{a:0, b:0}, 
                productsAffected: originalTx.productsAffected, timestamp: nowISO(), 
                note: reversalNote, orderId: order.id + '_r' 
            });
          }

          // B. Add expense for shipment loss (if any)
          if (loss > 0 && type !== 'delete') { // Only create reversal if not deleting the transaction entirely
              state.transactions.push({ 
                  id:uid('t'), type:'expense', category:'Return Loss', 
                  name:'Shipment loss', amount: -Math.abs(loss), ownerSplit:{a:0, b:0}, 
                  productsAffected:[], timestamp: nowISO(), note:'Return '+order.orderNo, 
                  orderId: order.id + '_l' 
              });
          }
          
          // C. If the entire order is to be deleted, remove the original sale transaction entirely.
          // This should only happen if 'type' is 'delete'.
          if (type === 'delete') {
            state.transactions.splice(saleTxIndex, 1);
            // Also remove any associated reversal/loss transactions just in case (e.g. if a cancel/return was performed first)
            state.transactions = state.transactions.filter(t => t.orderId !== order.id + '_r' && t.orderId !== order.id + '_l');
          }

      }
  }


  // ---------- Inline expand sections ----------

  // Orders inline expand
  let ordersInlineOpen = false;
  $('#card-orders').addEventListener('click', (e) => {
    if(ordersInlineOpen){ closeInline('orders'); return; }
    openInlineOrders();
  });

  function openInlineOrders(){
    ordersInlineOpen = true;
    const card = $('#card-orders'); card.classList.add('inline-expanded');
    // build inline list of last 6 orders
    const container = document.createElement('div'); container.className='inline-section'; container.id='orders-inline';
    const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    header.innerHTML = `<div style="font-weight:700">Recent orders</div><div><button class="btn ghost" id="view-all-orders">View All</button> <button class="btn" id="close-orders-inline">Close</button></div>`;
    container.appendChild(header);
    const tableWrap = document.createElement('div'); tableWrap.style.marginTop='10px'; tableWrap.style.maxHeight='220px'; tableWrap.style.overflow='auto';
    const table = document.createElement('table'); table.className='table';
    table.innerHTML = `<thead><tr><th>Order#</th><th>Buyer</th><th>Total</th><th>Status</th><th>When</th><th></th></tr></thead><tbody></tbody>`;
    tableWrap.appendChild(table); container.appendChild(tableWrap);
    card.appendChild(container);

    // fill rows
    const tbody = table.querySelector('tbody');
    const recent = state.orders.slice().sort((a,b)=> new Date(b.placedAt) - new Date(a.placedAt)).slice(0,6);
    if(recent.length===0){
      const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="6" class="muted small">No orders yet.</td>`; tbody.appendChild(tr);
    } else {
      recent.forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(o.orderNo)}</td><td>${escapeHtml(o.customerName)}</td><td>${currency(o.total)}</td><td><span class="status ${o.status}">${escapeHtml(o.status)}</span></td><td>${new Date(o.placedAt).toLocaleString()}</td><td style="text-align:right"><button class="btn btn-sm" data-id="${o.id}" data-action="inline-view">View</button></td>`;
        tbody.appendChild(tr);
      });
    }

    // handlers
    $('#close-orders-inline').onclick = ()=> closeInline('orders');
    $('#view-all-orders').onclick = ()=> { closeInline('orders'); openOrdersModal(); };

    tbody.addEventListener('click', (ev)=>{
      const b = ev.target.closest('button'); if(!b) return;
      if(b.dataset.action === 'inline-view'){ const id = b.dataset.id; openOrderViewModal(id); }
    });
  }
  function closeInline(name){
    if(name === 'orders'){
      ordersInlineOpen = false; const el = document.getElementById('orders-inline'); if(el) el.remove();
      $('#card-orders').classList.remove('inline-expanded');
    } else if (name === 'fin') {
      finInlineOpen=false; const el=document.getElementById('fin-inline'); if(el) el.remove(); $('#card-financials').classList.remove('inline-expanded');
    } else if (name === 'dispatch') {
      dispatchInlineOpen=false; const el=document.getElementById('dispatch-inline'); if(el) el.remove(); $('#card-dispatch').classList.remove('inline-expanded');
    } else if (name === 'investments') {
      investmentsInlineOpen = false; const el=document.getElementById('investments-inline'); if(el) el.remove(); $('#card-investments').classList.remove('inline-expanded');
    }
  }

  // Financials inline expand
  let finInlineOpen = false;
  $('#card-financials').addEventListener('click', (e)=> {
    // Prevent card click from opening/closing if a button inside was clicked
    if(e.target.closest('button#btn-reset-profit') || e.target.closest('button#btn-reset-all-financials')) return;

    if(finInlineOpen){ closeInline('fin'); return; }
    openInlineFin();
  });

  // Reset Resettable Metrics
  $('#btn-reset-profit').onclick = ()=> {
    if(confirm('Are you sure you want to reset the current Sales, Profit, and Investment values? This is typically done after a profit withdrawal or major investment milestone.')) {
        // NOTE: The values are recalculated based on transactions AFTER lastReset, so we only need to update the date.
        // The old code reset the values which is wrong if transactions were not cleared.
        state.resettableFin.lastReset = nowISO();
        save();
        renderDashboard();
        showToast('Resettable financials have been reset.');
    }
  };

  // Reset ALL Financials
  $('#btn-reset-all-financials').onclick = ()=> {
    if(confirm('WARNING: Are you sure you want to clear ALL transactions, which will reset TOTAL Sales, Net Profit, and Net Investment? This is generally used for a fresh start or at the end of a fiscal year.')) {
        state.transactions = []; // Clear all transactions
        state.resettableFin = {totalSales:0,netProfit:0,netInvestment:0,lastReset:nowISO()}; // Reset resettable as well
        state.orders = state.orders.filter(o => o.status === 'pending' || o.status === 'shipping'); // Keep only ongoing orders
        // Reset product stats (optional, but good for a "fresh start" concept)
        state.products.forEach(p => { p.sold = 0; p.returned = 0; p.cancelled = 0; });

        save();
        renderDashboard();
        showToast('All financial records have been reset.');
    }
  };


  function openInlineFin(){
    finInlineOpen = true;
    const card = $('#card-financials'); card.classList.add('inline-expanded');
    const cont = document.createElement('div'); cont.className='inline-section'; cont.id='fin-inline';
    const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    header.innerHTML = `<div style="font-weight:700">Financial details</div><div><button class="btn ghost" id="close-fin-inline">Close</button> <button class="btn" id="view-fin-full">View All</button></div>`;
    cont.appendChild(header);

    // compute sales-left-to-regain-investment
    const investTotal = state.transactions.filter(t=>t.type==='investment').reduce((s,t)=> s + Number(t.amount||0), 0); // positive inflow
    // Total profit from sales (we store profit as transaction.profit when sale recorded)
    const totalSaleProfit = state.transactions.filter(t=>t.type==='sale').reduce((s,t)=> s + Number(t.profit||0), 0);
    // Total expense outflows (recorded as negative amount in transactions)
    const expenseOutflows = state.transactions.filter(t => t.type === 'expense' || t.type === 'purchase').reduce((s, t) => s + Number(t.amount||0), 0);
    const netProfitTotal = totalSaleProfit + expenseOutflows;

    // Remaining to recover investment = Investment - Net Profit
    const investedRemaining = Math.max(0, investTotal - netProfitTotal);

    // avg profit per sale
    const saleTxs = state.transactions.filter(t=>t.type==='sale' && Number(t.profit)!=0);
    let avgProfit = 0;
    if(saleTxs.length>0){
      avgProfit = saleTxs.reduce((s,t)=> s + Number(t.profit||0), 0) / saleTxs.length;
    }
    const salesLeft = (avgProfit>0) ? Math.ceil(investedRemaining / avgProfit) : null;

    cont.innerHTML += `<div style="margin-top:10px" class="small muted">Investment total: <strong>${currency(investTotal)}</strong></div>
      <div class="small muted">Total sale profit: <strong>${currency(totalSaleProfit)}</strong></div>
      <div class="small muted">Total expenses/purchases: <strong>${currency(expenseOutflows)}</strong></div>
      <div class="small muted">Remaining to recover: <strong>${currency(investedRemaining)}</strong></div>
      <div class="small muted">Avg profit per sale: <strong>${avgProfit ? currency(avgProfit.toFixed(2)) : 'N/A'}</strong></div>
      <div class="small muted">Sales left to regain investment: <strong>${salesLeft===null? 'N/A' : salesLeft}</strong></div>`;

    card.appendChild(cont);
    $('#close-fin-inline').onclick = ()=> closeInline('fin');
    $('#view-fin-full').onclick = ()=> { closeInline('fin'); openTransactionsModal(); };
  }


  // Investments Card Inline Expand
  let investmentsInlineOpen = false;
  $('#card-investments').addEventListener('click', ()=> {
    if(investmentsInlineOpen){ closeInline('investments'); return; }
    openInlineInvestments();
  });

  function openInlineInvestments(){
    investmentsInlineOpen = true;
    const card = $('#card-investments'); card.classList.add('inline-expanded');
    const cont = document.createElement('div'); cont.className='inline-section'; cont.id='investments-inline';
    const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    header.innerHTML = `<div style="font-weight:700">Investment Timeline</div><div><button class="btn ghost" id="close-investments-inline">Close</button> <button class="btn" id="view-investments-full">View All</button></div>`;
    cont.appendChild(header);

    const tableWrap = document.createElement('div'); tableWrap.style.marginTop='10px'; tableWrap.style.maxHeight='220px'; tableWrap.style.overflow='auto';
    const table = document.createElement('table'); table.className='table';
    table.innerHTML = `<thead><tr><th>When</th><th>Category</th><th>Amount</th><th>Note</th></tr></thead><tbody></tbody>`;
    tableWrap.appendChild(table); cont.appendChild(tableWrap);

    // fill rows
    const tbody = table.querySelector('tbody');
    const recent = state.transactions.filter(t=>t.type==='investment').slice().sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp)).slice(0,6);
    if(recent.length===0){
      const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="4" class="muted small">No investment transactions yet.</td>`; tbody.appendChild(tr);
    } else {
      recent.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(t.timestamp).toLocaleDateString()}</td><td>${escapeHtml(t.category)}</td><td>${currency(t.amount)}</td><td>${escapeHtml(t.note||'—')}</td>`;
        tbody.appendChild(tr);
      });
    }

    card.appendChild(cont);
    $('#close-investments-inline').onclick = ()=> closeInline('investments');
    $('#view-investments-full').onclick = ()=> { closeInline('investments'); openTransactionsModal('investment'); }; // Pass filter to transactions modal
  }


  // Dispatch inline expand (orders status controls)
  let dispatchInlineOpen = false;
  $('#card-dispatch').addEventListener('click', ()=> {
    if(dispatchInlineOpen){ closeInline('dispatch'); return; }
    openInlineDispatch();
  });
  function openInlineDispatch(){
    dispatchInlineOpen = true;
    const card = $('#card-dispatch'); card.classList.add('inline-expanded');
    const cont = document.createElement('div'); cont.className='inline-section'; cont.id='dispatch-inline';
    cont.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">Quick Order Management</div><div><button class="btn ghost" id="close-dispatch-inline">Close</button></div></div>`;
    const list = document.createElement('div'); list.style.marginTop='8px'; list.id='dispatch-list';
    cont.appendChild(list);
    card.appendChild(cont);
    $('#close-dispatch-inline').onclick = ()=> closeInline('dispatch');
    renderDispatchList();
  }
  function renderDispatchList(){
    const list = $('#dispatch-list'); list.innerHTML='';
    const subset = state.orders.slice().filter(o=> o.status==='shipping' || o.status==='pending').slice(0,8);
    if(subset.length===0){ list.innerHTML = '<div class="muted small">No ongoing orders.</div>'; return; }
    subset.forEach(o=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='8px';
      // Replaced status-select with Action button to go to quick-action modal
      row.innerHTML = `<div><div style="font-weight:700">${escapeHtml(o.orderNo)}</div><div class="muted small">${escapeHtml(o.customerName)}</div></div>
        <div style="display:flex;gap:8px;align-items:center"><span class="status ${o.status}">${escapeHtml(o.status)}</span><button class="btn btn-sm" data-id="${o.id}" data-action="quick-action">Action</button></div>`;
      list.appendChild(row);
    });

    // attach action handlers
    list.querySelectorAll('button[data-action="quick-action"]').forEach(b => {
      b.onclick = () => openOrderQuickActionModal(b.dataset.id);
    });
  }
  
  // New Quick Action Modal: allows change status or delete
  function openOrderQuickActionModal(id) {
    const o = state.orders.find(x => x.id === id); if (!o) return;
    const html = `<h3>Quick Action — ${escapeHtml(o.orderNo)}</h3>
      <div style="display:grid;gap:12px;margin-top:8px">
        <button class="btn primary" data-id="${o.id}" id="quick-change-status">Change Status</button>
        <button class="btn danger" data-id="${o.id}" id="quick-delete-order">Delete Order</button>
        <button class="btn ghost" id="quick-action-cancel">Cancel</button>
      </div>`;
    openModal(html);
    $('#quick-action-cancel').onclick = closeModal;
    $('#quick-change-status').onclick = () => { closeModal(); changeOrderStatusModal(id); };
    $('#quick-delete-order').onclick = () => { closeModal(); deleteOrder(id); };
  }

  // --- NEW FUNCTION: Delete Order (Fix for Issue 2) ---
  function deleteOrder(id) {
      if (!confirm('WARNING: Are you sure you want to completely DELETE this order? This will remove the order and all associated sale transactions and restore stock.')) {
          return;
      }
      const oIndex = state.orders.findIndex(x => x.id === id);
      if (oIndex === -1) { showToast('Order not found.'); return; }
      const order = state.orders[oIndex];

      // Reverse financial and stock effects before deletion
      reverseSaleEffects(order, 'delete', 0); // 'delete' type ensures original transaction is removed

      // Remove the order
      state.orders.splice(oIndex, 1);
      
      save(); 
      renderDashboard(); 
      if (dispatchInlineOpen) renderDispatchList(); 
      showToast(`Order ${order.orderNo} deleted.`);
  }

  // Modified changeOrderStatusInline (now only handles status change from inline dispatch)
  function changeOrderStatusInline(orderId, newStatus){
    const o = state.orders.find(x=> x.id === orderId);
    if(!o) return;

    // --- LOGIC FOR ISSUE 1: Reversal on Cancel/Return ---
    if((newStatus === 'cancelled' || newStatus === 'returned') && o.status !== newStatus){
        // Only reverse if the status is actually changing to cancelled or returned for the first time
        reverseSaleEffects(o, newStatus, 0); // Loss is handled in the full modal
    }
    // --- END ISSUE 1 LOGIC ---

    // NOTE: The previous code for restoring stock on return is moved to reverseSaleEffects for consistency
    
    o.status = newStatus; o.statusHistory = o.statusHistory || []; o.statusHistory.push({ status:newStatus, at: nowISO()});
    save(); renderDashboard(); renderDispatchList();
    showToast('Order status updated');
  }

  // IO card actions
  $('#export-csv').onclick = ()=> exportCSV();
  $('#export-styled').onclick = ()=> { exportStyledHTML(); showToast('Styled export created'); };
  $('#import-file').onclick = ()=> $('#file-input').click();
  $('#file-input').addEventListener('change', (ev)=> {
    const f = ev.target.files[0]; if(!f) return;
    importFile(f);
    ev.target.value = '';
  });

  // Products card (modal)
  $('#card-products').addEventListener('click', () => openProductsModal());
  $('#btn-products').onclick = () => openProductsModal();

  // Transactions card (modal)
  $('#card-tx').addEventListener('click', () => openTransactionsModal());

  // Investments card (modal)
  $('#card-investments').addEventListener('click', () => openTransactionsModal('investment')); // Open TX modal pre-filtered

  // Sell button
  $('#btn-sell').onclick = () => openSellModal();

  // Import/Export header buttons
  $('#btn-import').onclick = ()=> $('#file-input').click();
  $('#btn-export').onclick = ()=> { exportCSV(); exportStyledHTML(); showToast('Exports ready'); };

  // ---------- Products modal (full page) ----------
  function openProductsModal(){
    const html = `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Products</h2><div><button class="btn ghost" id="close-products">Close</button> <button class="btn" id="add-product">Add Product</button></div></div>
      <div style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center"><div class="search" style="width:420px"><input id="search-prod" placeholder="Search product name or SKU"></div><button class="btn ghost" id="import-products">Import CSV</button> <button class="btn ghost" id="export-products">Export CSV</button></div>
        <div style="margin-top:12px;max-height:520px;overflow:auto"><table class="table" id="products-table-full"><thead><tr><th>Name</th><th>SKU</th><th>Price</th><th>Cost</th><th>Purchased</th><th>Stock</th><th>Sold</th><th>Returned</th><th>Cancelled</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
      </div>`;
    openModal(html);
    $('#close-products').onclick = closeModal;
    $('#add-product').onclick = ()=> openAddProductModal(); // Correct binding
    $('#import-products').onclick = ()=> $('#file-input').click();
    $('#export-products').onclick = ()=> exportProductsCSV();
    $('#search-prod').addEventListener('input', (e)=> renderProductsFull(e.target.value));
    renderProductsFull('');
  }

  function renderProductsFull(filter=''){
    const tbody = $('#products-table-full tbody'); tbody.innerHTML = '';
    const q = filter.trim().toLowerCase();
    state.products.filter(p => !q || p.name.toLowerCase().includes(q) || p.sku.toLowerCase().includes(q)).forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(p.name)}</td>
        <td>${escapeHtml(p.sku)}</td>
        <td>${currency(p.price)}</td>
        <td>${currency(p.cost)}</td>
        <td>${Number(p.purchased||0)}</td>
        <td>${Number(p.stock||0)}</td>
        <td>${Number(p.sold||0)}</td>
        <td>${Number(p.returned||0)}</td>
        <td>${Number(p.cancelled||0)}</td>
        <td style="text-align:right"><button class="btn btn-sm" data-id="${p.id}" data-action="edit-prod">Edit</button> <button class="btn btn-sm ghost" data-id="${p.id}" data-action="del-prod">Delete</button></td>`;
      tbody.appendChild(tr);
    });
    // delegation
    tbody.querySelectorAll('button[data-action="edit-prod"]').forEach(b => b.onclick = ()=> openEditProductModal(b.dataset.id));
    tbody.querySelectorAll('button[data-action="del-prod"]').forEach(b => b.onclick = ()=> { if(confirm('Delete product?')) { state.products = state.products.filter(x=>x.id!==b.dataset.id); save(); renderProductsFull(filter); renderDashboard(); showToast('Product deleted'); } });
  }

  function openAddProductModal(){
    const html = `<h3>Add Product</h3>
      <div style="display:grid;gap:8px;margin-top:8px">
        <div class="field"><label>Product name</label><input id="p-name"/></div>
        <div class="field"><label>SKU</label><input id="p-sku"/></div>
        <div style="display:flex;gap:8px"><div class="field" style="flex:1"><label>Price</label><input id="p-price" type="number"/></div><div class="field" style="width:140px"><label>Cost</label><input id="p-cost" type="number"/></div></div>
        <div style="display:flex;gap:8px"><div class="field" style="flex:1"><label>Purchased qty</label><input id="p-purchased" type="number" value="0"/></div><div class="field" style="width:140px"><label>Stock</label><input id="p-stock" type="number" value="0"/></div></div>
        <div style="display:flex;justify-content:flex-end;gap:8px"><button class="btn ghost" id="cancel-add-prod">Cancel</button><button class="btn" id="save-add-prod">Save</button></div>
      </div>`;
    openModal(html);
    $('#cancel-add-prod').onclick = closeModal;
    $('#save-add-prod').onclick = ()=> {
      const name = $('#p-name').value.trim(), sku = $('#p-sku').value.trim();
      if(!name || !sku){ alert('Name and SKU required'); return; }
      const p = { id:uid('p'), name, sku, price: Number($('#p-price').value||0), cost: Number($('#p-cost').value||0), purchased: Number($('#p-purchased').value||0), stock: Number($('#p-stock').value||0), sold:0, returned:0, cancelled:0 };
      state.products.push(p); save(); closeModal(); renderProductsFull(''); renderDashboard(); showToast('Product added');
    };
  }

  function openEditProductModal(id){
    const p = state.products.find(x=> x.id === id); if(!p) return;
    const html = `<h3>Edit Product</h3>
      <div style="display:grid;gap:8px;margin-top:8px">
        <div class="field"><label>Product name</label><input id="p-name" value="${escapeHtml(p.name)}"/></div>
        <div class="field"><label>SKU</label><input id="p-sku" value="${escapeHtml(p.sku)}"/></div>
        <div style="display:flex;gap:8px"><div class="field" style="flex:1"><label>Price</label><input id="p-price" type="number" value="${p.price}"/></div><div class="field" style="width:140px"><label>Cost</label><input id="p-cost" type="number" value="${p.cost}"/></div></div>
        <div style="display:flex;gap:8px"><div class="field" style="flex:1"><label>Purchased qty</label><input id="p-purchased" type="number" value="${p.purchased||0}"/></div><div class="field" style="width:140px"><label>Stock</label><input id="p-stock" type="number" value="${p.stock||0}"/></div></div>
        <div style="display:flex;gap:8px"><div class="field" style="flex:1"><label>Sold</label><input id="p-sold" type="number" value="${p.sold||0}"/></div><div class="field" style="width:140px"><label>Returned</label><input id="p-returned" type="number" value="${p.returned||0}"/></div></div>
        <div style="display:flex;justify-content:flex-end;gap:8px"><button class="btn ghost" id="cancel-edit-prod">Cancel</button><button class="btn" id="save-edit-prod">Save</button></div>
      </div>`;
    openModal(html);
    $('#cancel-edit-prod').onclick = closeModal;
    $('#save-edit-prod').onclick = ()=> {
      p.name = $('#p-name').value.trim(); p.sku = $('#p-sku').value.trim(); p.price = Number($('#p-price').value||0); p.cost = Number($('#p-cost').value||0);
      p.purchased = Number($('#p-purchased').value||0); p.stock = Number($('#p-stock').value||0);
      p.sold = Number($('#p-sold').value||0); p.returned = Number($('#p-returned').value||0);
      save(); closeModal(); renderProductsFull(''); renderDashboard(); showToast('Product updated');
    };
  }

  // ---------- Orders modal (full page with search & filters) ----------
  function openOrdersModal(){
    const html = `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Orders</h2><div><button class="btn ghost" id="close-orders-modal">Close</button></div></div>
      <div style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center"><div class="search" style="width:360px"><input id="search-orders-full" placeholder="Search by name, address, order#"></div>
        <input id="filter-order-from" type="date"><input id="filter-order-to" type="date">
        <select id="filter-order-status"><option value="">All status</option><option>pending</option><option>shipping</option><option>delivered</option><option>cancelled</option><option>returned</option></select>
        <button class="btn" id="apply-orders-filter">Apply</button></div>

        <div style="margin-top:12px;max-height:520px;overflow:auto"><table class="table" id="orders-table-full"><thead><tr><th>Order#</th><th>Buyer</th><th>Total</th><th>Payment</th><th>Status</th><th>Placed</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
      </div>`;
    openModal(html);
    $('#close-orders-modal').onclick = closeModal;
    $('#apply-orders-filter').onclick = ()=> renderOrdersFull($('#search-orders-full').value, $('#filter-order-status').value, $('#filter-order-from').value, $('#filter-order-to').value);
    $('#search-orders-full').addEventListener('input', (e)=> renderOrdersFull(e.target.value, $('#filter-order-status').value, $('#filter-order-from').value, $('#filter-order-to').value));
    $('#filter-order-status').addEventListener('change', ()=> renderOrdersFull($('#search-orders-full').value, $('#filter-order-status').value, $('#filter-order-from').value, $('#filter-order-to').value));
    renderOrdersFull('', '', '', '');
  }

  function renderOrdersFull(q='', status='', from='', to=''){
    const tbody = $('#orders-table-full tbody'); tbody.innerHTML = '';
    const ql = q.trim().toLowerCase();
    const fromDate = from ? new Date(from + 'T00:00:00') : null;
    const toDate = to ? new Date(to + 'T23:59:59') : null;
    state.orders.slice().sort((a,b)=> new Date(b.placedAt) - new Date(a.placedAt)).forEach(o=>{
      if(status && o.status !== status) return;
      if(ql){
        const hay = `${o.customerName} ${o.address} ${o.orderNo} ${o.paymentType} ${o.total}`.toLowerCase();
        if(!hay.includes(ql)) return;
      }
      const placed = new Date(o.placedAt);
      if(fromDate && placed < fromDate) return;
      if(toDate && placed > toDate) return;
      const tr = document.createElement('tr');
      // Removed Address column to save space, but it's still searchable.
      tr.innerHTML = `<td>${escapeHtml(o.orderNo)}</td>
        <td>${escapeHtml(o.customerName)}</td>
        <td>${currency(o.total)}</td>
        <td>${escapeHtml(o.paymentType)}</td>
        <td><span class="status ${o.status}">${escapeHtml(o.status)}</span></td>
        <td>${placed.toLocaleString()}</td>
        <td style="text-align:right"><button class="btn btn-sm" data-id="${o.id}" data-action="view-order">View</button> <button class="btn btn-sm ghost" data-id="${o.id}" data-action="order-action">Action</button></td>`;
      tbody.appendChild(tr);
    });
    // delegates
    tbody.querySelectorAll('button[data-action="view-order"]').forEach(b=> b.onclick = ()=> openOrderViewModal(b.dataset.id));
    // Changed change-order to order-action
    tbody.querySelectorAll('button[data-action="order-action"]').forEach(b=> b.onclick = ()=> openOrderQuickActionModal(b.dataset.id));
  }

  // ---------- Single order view modal ----------
  function openOrderViewModal(id){
    const o = state.orders.find(x=> x.id === id); if(!o) return;
    const itemsHtml = o.items.map(it=> `<div>${escapeHtml(it.sku)} × ${it.qty} @ ${currency(it.price)}</div>`).join('');
    const html = `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Order ${escapeHtml(o.orderNo)}</h2><div><button class="btn ghost" id="close-order-view">Close</button></div></div>
      <div style="margin-top:12px"><div class="muted small">Buyer</div><div style="font-weight:700">${escapeHtml(o.customerName)}</div><div class="muted small">Address</div><div>${escapeHtml(o.address)}</div>
      <div style="margin-top:8px"><strong>Items:</strong>${itemsHtml}</div>
      <div style="margin-top:8px" class="small muted">Shipping Charge: ${currency(o.shippingCharge||0)}</div>
      <div style="margin-top:8px;font-weight:800">Total: ${currency(o.total)}</div>
      <div style="margin-top:12px;display:flex;gap:8px"><button class="btn" id="btn-action-status">Action</button><button class="btn ghost" id="btn-export-order">Export</button></div></div>`;
    openModal(html);
    $('#close-order-view').onclick = closeModal;
    $('#btn-action-status').onclick = ()=> { closeModal(); openOrderQuickActionModal(id); }; // Changed button to Action
    $('#btn-export-order').onclick = ()=> { 
        const itemsList = o.items.map(it=> `<li>${escapeHtml(it.sku)} × ${it.qty} @ ${currency(it.price)}</li>`).join('');
        const out = `<html><body><h3>Order ${escapeHtml(o.orderNo)}</h3><p>Total: ${currency(o.total)}</p><p>Shipping: ${currency(o.shippingCharge||0)}</p><ul>${itemsList}</ul></body></html>`; 
        download('order-'+o.orderNo+'.html', out, 'text/html'); 
    };
  }

  // ---------- Change order status modal (full) ----------
  function changeOrderStatusModal(id){
    const o = state.orders.find(x=> x.id === id); if(!o) return;
    const html = `<h3>Change Status — ${escapeHtml(o.orderNo)}</h3>
      <div style="display:grid;gap:8px;margin-top:8px">
        <div class="field"><label>New status</label><select id="new-order-status"><option>pending</option><option>shipping</option><option>delivered</option><option>cancelled</option><option>returned</option></select></div>
        <div class="field"><label>If returned: shipment loss amount (if the item/shipment is a total loss)</label><input id="return-loss" type="number" value="0"/></div>
        <div style="display:flex;justify-content:flex-end;gap:8px"><button class="btn ghost" id="cancel-change-order">Cancel</button><button class="btn" id="apply-change-order">Apply</button></div>
      </div>`;
    openModal(html);
    $('#new-order-status').value = o.status; // Set current status
    $('#cancel-change-order').onclick = closeModal;
    $('#apply-change-order').onclick = ()=>{
      const ns = $('#new-order-status').value; 
      const loss = Number($('#return-loss').value || 0);

      // --- LOGIC FOR ISSUE 1: Reversal on Cancel/Return ---
      if(ns === 'cancelled' && o.status !== 'cancelled'){
          reverseSaleEffects(o, 'cancelled', 0); // Loss of profit/stock restore
      } else if (ns === 'returned' && o.status !== 'returned'){
          reverseSaleEffects(o, 'returned', loss); // Loss of profit/stock restore + shipment loss expense
      }
      // --- END ISSUE 1 LOGIC ---

      o.status = ns; o.statusHistory = o.statusHistory || []; o.statusHistory.push({ status:ns, at: nowISO()});
      save(); closeModal(); renderDashboard(); showToast('Order updated');
    };
  }

  // ---------- Transactions Modal (full page) ----------
  function openTransactionsModal(initialFilter=''){
    const html = `<div style="display:flex;justify-content:space-between;align-items:center"><h2>Transactions</h2><div><button class="btn ghost" id="close-tx">Close</button> <button class="btn" id="add-tx">Add Other Transaction</button></div></div>
      <div style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center"><select id="tx-filter-type"><option value="">All</option><option value="sale">Sale</option><option value="purchase">Purchase</option><option value="investment">Investment</option><option value="expense">Expense</option></select>
        <input id="tx-from" type="date"><input id="tx-to" type="date"><button class="btn" id="apply-tx-filter">Filter</button></div>
        <div style="margin-top:12px;max-height:520px;overflow:auto"><table class="table" id="tx-table-full"><thead><tr><th>When</th><th>Type</th><th>Details</th><th>Amount</th><th>Profit</th></tr></thead><tbody></tbody></table></div>
      </div>`;
    openModal(html);
    $('#close-tx').onclick = closeModal;
    $('#add-tx').onclick = ()=> openAddTransactionModal();
    $('#apply-tx-filter').onclick = ()=> renderTransactionsFull($('#tx-filter-type').value, $('#tx-from').value, $('#tx-to').value);

    // Apply initial filter if provided
    if (initialFilter) {
      $('#tx-filter-type').value = initialFilter;
    }

    renderTransactionsFull($('#tx-filter-type').value, '', '');
  }

  function renderTransactionsFull(filter='', from='', to=''){
    const tbody = $('#tx-table-full tbody'); tbody.innerHTML = '';
    const fromDate = from ? new Date(from + 'T00:00:00') : null;
    const toDate = to ? new Date(to + 'T23:59:59') : null;
    state.transactions.slice().sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp)).forEach(t=>{
      if(filter && t.type !== filter) return;
      const ts = new Date(t.timestamp);
      if(fromDate && ts < fromDate) return;
      if(toDate && ts > toDate) return;

      const tr = document.createElement('tr');
      // Sales/Investment are green, Purchases/Expenses are red (as they are outflows, stored as negative amount)
      let amountCls = '';
      if (t.type === 'sale' || t.type === 'investment') amountCls = 'style="color:green;font-weight:700"';
      // Use Math.abs for absolute amount display for Purchases/Expenses
      else if (t.type === 'purchase' || t.type === 'expense') amountCls = 'style="color:red;font-weight:700"';

      const profitCol = t.type === 'sale' ? currency(t.profit) : '—';
      const displayAmount = t.type === 'purchase' || t.type === 'expense' ? currency(Math.abs(t.amount)) : currency(t.amount);

      tr.innerHTML = `<td>${ts.toLocaleString()}</td><td>${escapeHtml(t.type)}</td><td>${escapeHtml((t.category||'') + ' ' + (t.name||''))} ${t.productsAffected?('<div class="muted small">'+ t.productsAffected.map(x=> x.sku+'×'+x.qty).join(', ') + '</div>') : ''} <div class="muted small">${escapeHtml(t.note||'')}</div></td><td ${amountCls}>${displayAmount}</td><td>${profitCol}</td>`;
      tbody.appendChild(tr);
    });
  }

  function openAddTransactionModal(){
    const html = `<h3>Add Other Transaction (Investment, Purchase, or Expense)</h3>
      <div style="display:grid;gap:8px;margin-top:8px">
        <div class="field"><label>Type</label><select id="tx-type-select"><option value="investment">Investment (Cash In)</option><option value="purchase">Stock Purchase (Cash Out)</option><option value="expense">Other Expense (Cash Out)</option></select></div>
        <div class="field"><label>Category</label><input id="tx-category" placeholder="e.g. Initial Capital, Website Renewal, New Stock"/></div>
        <div class="field"><label>Name / Description</label><input id="tx-name" placeholder="Short description of the transaction"/></div>
        <div style="display:flex;gap:8px"><div class="field" style="flex:1"><label>Amount (positive for Inflow, negative for Outflow)</label><input id="tx-amount" type="number" placeholder="Enter positive for Inflow, negative for Outflow"/></div><div class="field" style="width:180px"><label>Transaction Date</label><input id="tx-date" type="date" value="${toISODate(new Date())}"/></div></div>
        <div class="field"><label>Note</label><textarea id="tx-note"></textarea></div>
        <div style="display:flex;justify-content:flex-end;gap:8px"><button class="btn ghost" id="cancel-tx">Cancel</button><button class="btn" id="save-tx">Save</button></div>
      </div>`;
    openModal(html);
    $('#cancel-tx').onclick = closeModal;
    $('#save-tx').onclick = ()=>{
      const type = $('#tx-type-select').value; let amt = Number($('#tx-amount').value||0);
      const category = $('#tx-category').value.trim();
      const name = $('#tx-name').value.trim();
      const note = $('#tx-note').value.trim();
      const txDate = $('#tx-date').value;

      if(amt === 0) { alert('Amount cannot be zero.'); return; }
      if(!category) { alert('Category is required.'); return; }
      if(!txDate) { alert('Transaction date is required.'); return; }

      // Use the provided date, defaulting to 12:00:00 of that day
      const timestamp = new Date(txDate + 'T12:00:00Z').toISOString();

      if(type === 'investment' && amt < 0) { alert('Investment must be a POSITIVE amount (inflow).'); return; }
      if((type === 'purchase' || type === 'expense') && amt > 0) {
        // Enforce negative amount for outflow, if user entered positive
        amt = -Math.abs(amt);
      }

      // create tx (ownerSplit is kept for structure, but is zeroed as per request)
      const tx = { id:uid('t'), type, category, name, amount: amt, ownerSplit:{a:0, b:0}, productsAffected:[], timestamp, note };
      state.transactions.push(tx);

      // if purchase, optionally ask to add to stock
      if(type === 'purchase'){
        const sku = prompt('If this purchase applies to product stock, enter its SKU (leave blank to skip adding stock):','');
        if(sku){
          const p = state.products.find(pp => pp.sku === sku);
          if(p){
            const q = Number(prompt('Quantity purchased to add to stock (enter 0 to skip stock update)','0')||0);
            if(q > 0){
              p.purchased = (Number(p.purchased)||0) + q;
              p.stock = (Number(p.stock)||0) + q;
              tx.productsAffected.push({sku:p.sku, qty:q}); // record what stock was affected
              showToast('Stock updated successfully.');
            }
          } else {
            alert('SKU not found; purchase saved as transaction only.');
          }
        }
      }

      save(); closeModal(); renderDashboard(); showToast('Transaction saved');
    };
  }

  // ---------- Sell product modal ----------
  function openSellModal(prefSku){
    const options = state.products.map(p => `<option value="${p.id}" data-sku="${p.sku}" data-price="${p.price}" data-cost="${p.cost}" data-stock="${p.stock}">${escapeHtml(p.name)} — ${escapeHtml(p.sku)} (stock:${p.stock})</option>`).join('');
    const html = `<h3>Sell product / Create order</h3>
      <div style="display:grid;gap:8px;margin-top:8px">
        <div class="field"><label>Product</label><select id="sell-product"><option value="">-- choose --</option>${options}</select></div>
        <div style="display:flex;gap:8px"><div class="field" style="flex:1"><label>SKU</label><input id="sell-sku" readonly/></div><div class="field" style="width:140px"><label>Stock</label><input id="sell-stock" readonly/></div></div>

        <div style="display:flex;gap:8px">
            <div class="field" style="flex:1"><label>Price/unit (Default)</label><input id="sell-price-placeholder" readonly/></div>
            <div class="field" style="flex:1"><label>Quantity</label><input id="sell-qty" type="number" min="1" value="1"/></div>
        </div>
        <div class="checkbox-field">
            <input type="checkbox" id="custom-price-checkbox" style="width:auto;margin:0"/>
            <label for="custom-price-checkbox">Use Custom Price?</label>
        </div>
        <div class="field" id="custom-price-field" style="display:none"><label>Custom Selling Price/unit</label><input id="sell-custom-price" type="number" step="0.01"/></div>
        
        <div class="field"><label>Shipping Charge (Collected from Customer)</label><input id="sell-shipping-charge" type="number" value="0" step="0.01"/></div>
        
        <div class="field" style="width:160px"><label>Payment</label><select id="sell-pay"><option>UPI</option><option>Cash</option><option>Card</option></select></div>
        <div class="field"><label>Buyer name</label><input id="sell-name"/></div>
        <div class="field"><label>Address</label><textarea id="sell-address"></textarea></div>
        <div style="display:flex;gap:8px"><div class="field" style="flex:1"><label>Note</label><textarea id="sell-note"></textarea></div><div class="field" style="width:180px"><label>Sale Date</label><input id="sell-date" type="date" value="${toISODate(new Date())}"/></div></div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="muted small">If stock is zero, sale is blocked.</div>
          <div style="display:flex;gap:8px"><button class="btn ghost" id="cancel-sell">Cancel</button><button class="btn primary" id="confirm-sell">Confirm Sale</button></div>
        </div>
      </div>`;
    openModal(html);
    // handlers
    $('#cancel-sell').onclick = closeModal;
    const sel = $('#sell-product'), skuIn = $('#sell-sku'), stockIn = $('#sell-stock'), qtyIn = $('#sell-qty');
    const pricePlaceholder = $('#sell-price-placeholder');
    const customPriceCheckbox = $('#custom-price-checkbox');
    const customPriceField = $('#custom-price-field');
    const customPriceInput = $('#sell-custom-price');
    const shippingChargeInput = $('#sell-shipping-charge'); // Issue 3

    function updateSel(){
      const opt = sel.selectedOptions[0];
      if(!opt){
        skuIn.value=''; stockIn.value=''; qtyIn.max = 99999;
        pricePlaceholder.value = '';
        customPriceInput.value = '';
        customPriceCheckbox.checked = false;
        customPriceField.style.display = 'none';
        return;
      }
      skuIn.value = opt.dataset.sku || '';
      stockIn.value = opt.dataset.stock || '0';
      qtyIn.max = Number(opt.dataset.stock)||99999;
      pricePlaceholder.value = currency(opt.dataset.price);
    }

    function toggleCustomPrice(){
        customPriceField.style.display = customPriceCheckbox.checked ? 'block' : 'none';
        if (!customPriceCheckbox.checked) {
            customPriceInput.value = ''; // Clear custom price when turning off
        }
    }

    sel.onchange = updateSel;
    customPriceCheckbox.onchange = toggleCustomPrice;

    if(prefSku){ const p = state.products.find(x=> x.sku===prefSku); if(p) sel.value = p.id; }
    updateSel();

    $('#confirm-sell').onclick = ()=> {
      const pid = sel.value; if(!pid){ alert('Select product'); return; }
      const p = state.products.find(x=> x.id === pid); if(!p){ alert('Product not found'); return; }
      const qty = Number(qtyIn.value||0); if(qty <= 0){ alert('Quantity > 0'); return; }
      if(Number(p.stock||0) < qty){ alert('Not enough stock. Current: ' + (p.stock||0)); return; }

      const saleDate = $('#sell-date').value; if(!saleDate) { alert('Sale date is required.'); return; }
      
      // Determine the selling price per unit
      let sellingPricePerUnit = Number(p.price||0);
      let isCustomPrice = false;
      if (customPriceCheckbox.checked) {
          const customPrice = Number(customPriceInput.value||0);
          if (customPrice > 0) {
              sellingPricePerUnit = customPrice;
              isCustomPrice = true;
          } else {
              alert('Custom price must be greater than zero.');
              return;
          }
      }
      
      // Get Shipping Charge
      const shippingCharge = Number(shippingChargeInput.value || 0);

      // Use the provided date, defaulting to 12:00:00 of that day for transaction/order timestamp
      const timestamp = new Date(saleDate + 'T12:00:00Z').toISOString();

      // proceed sale: reduce stock, create order and transaction
      p.stock = Number(p.stock||0) - qty; p.sold = Number(p.sold||0) + qty;
      
      // --- START: CORRECTED FINANCIAL LOGIC ---
      // 1. Goods Sale Total: Revenue from the goods only
      const goodsSaleTotal = sellingPricePerUnit * qty; 
      
      // 2. Total Gross Amount: Total cash received from the customer (used for order total)
      const totalGrossAmount = goodsSaleTotal + shippingCharge; 

      // 3. Gross Profit: Only from the sale of goods. Shipping is excluded from profit.
      // (The actual shipping cost should be recorded separately as an 'expense' transaction later to properly reflect Net Profit.)
      const profit = (sellingPricePerUnit - Number(p.cost||0)) * qty; 
      // --- END: CORRECTED FINANCIAL LOGIC ---

      const orderId = uid('o');
      
      // Transaction: Amount is the Goods Sale Total only (for 'Total Sales' KPI). Profit is Goods Profit.
      // NOTE: The cash received includes the shipping charge, but for 'Total Sales' and 'Profit' KPIs, 
      // we only account for the goods revenue and profit, keeping the shipping charge neutral 
      // until an actual shipping expense is recorded.
      const tx = { 
          id:uid('t'), 
          type:'sale', 
          category:'Retail', 
          name:p.name + (isCustomPrice ? ' (Custom Price)' : '') + (shippingCharge > 0 ? ' + Shipping Received' : ''), 
          amount: goodsSaleTotal, // ONLY GOODS REVENUE for Total Sales KPI
          profit: profit, // ONLY GOODS PROFIT for Net Profit KPI
          ownerSplit:{a:0, b:0}, 
          productsAffected:[{sku:p.sku, qty}], 
          timestamp, 
          note: $('#sell-note').value||'',
          orderId: orderId // Link transaction to order
      };
      state.transactions.push(tx);

      // Order: The item price recorded in the order is the price at which it was sold (can be custom price)
      const order = { 
          id: orderId, // Use the shared ID
          orderNo: 'ORD' + Math.floor(Math.random()*900000+10000), 
          customerName: $('#sell-name').value||'Unknown', 
          address: $('#sell-address').value||'', 
          items:[{sku:p.sku, qty, price:sellingPricePerUnit}], // Use actual selling price
          total: totalGrossAmount, // Total is the full amount including shipping (cash received)
          paymentType: $('#sell-pay').value, 
          status:'shipping', 
          placedAt: timestamp, 
          statusHistory:[{status:'placed', at: timestamp}], 
          note: $('#sell-note').value||'',
          shippingCharge: shippingCharge 
      };
      state.orders.push(order);

      save(); closeModal(); renderDashboard(); showToast('Sale & order created');
    };
  }

  // ---------- Order created via other flows ----------
  // open modal helper
  function openModal(html){
    $('#modal-content').innerHTML = html;
    document.getElementById('modal-root').style.display = 'flex';
    document.getElementById('modal-root').setAttribute('aria-hidden', 'false');
  }
  function closeModal(){
    document.getElementById('modal-root').style.display = 'none';
    document.getElementById('modal-root').setAttribute('aria-hidden', 'true');
    document.getElementById('modal-content').innerHTML = '';
  }
  // close on background click
  document.getElementById('modal-root').addEventListener('click', function(e){
    if(e.target === this) closeModal();
  });

  // ---------- Import / Export ----------

  function exportCSV(){
    // Export orders, products, transactions in separate sections in one CSV file (simple).
    const lines = [];
    lines.push('SECTION,TYPE,ID,REF,NAME,SKU,AMOUNT,PROFIT,STATUS,NOTE,WHEN');
    state.transactions.forEach(t=>{
      // Use PROFIT field for sales, empty for others
      const profitCol = t.type === 'sale' ? t.profit : '';
      const amount = t.type === 'purchase' || t.type === 'expense' ? Math.abs(t.amount) : t.amount; // Export outflows as positive for clarity
      lines.push(['TRANSACTION', t.type, t.id, t.name||'', (t.productsAffected? t.productsAffected.map(x=>x.sku).join('|') : ''), amount, profitCol, '', t.note||'', t.timestamp].map(csvSafe).join(','));
    });
    state.orders.forEach(o=>{
      // Added shipping charge to order export
      lines.push(['ORDER', 'order', o.id, o.orderNo, o.customerName, o.items.map(i=>i.sku).join('|'), o.total, o.shippingCharge, o.status, o.note||'', o.placedAt].map(csvSafe).join(','));
    });
    state.products.forEach(p=>{
      lines.push(['PRODUCT', 'product', p.id, p.sku, p.name, p.sku, p.price, p.cost, '', '', ''].map(csvSafe).join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gadgetpro_export.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  function exportStyledHTML(){
    // Investments green, purchases/expenses red, profit green/red
    let html = `<html><head><meta charset="utf-8"><title>GadgetPro Styled Export</title><style>table{border-collapse:collapse}td,th{border:1px solid #ddd;padding:8px} .green{color:var(--success);font-weight:700}.red{color:var(--danger);font-weight:700}.black{color:var(--text)}</style></head><body><h2>Transactions</h2><table><thead><tr><th>When</th><th>Type</th><th>Name</th><th>SKU(s)</th><th>Amount</th><th>Profit</th><th>Note</th></tr></thead><tbody>`;
    state.transactions.slice().sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp)).forEach(t=>{
      let cls='black';
      // Inflows are green
      if(t.type === 'investment' || (t.type === 'sale' && t.profit >= 0)) cls='green';
      // Outflows/Losses are red
      if(t.type === 'expense' || t.type === 'purchase' || (t.type === 'sale' && t.profit < 0)) cls='red';
      const profitCol = t.type === 'sale' ? currency(t.profit) : '—';
      const displayAmount = t.type === 'purchase' || t.type === 'expense' ? currency(Math.abs(t.amount)) : currency(t.amount); // Show absolute amount for outflows
      html += `<tr><td>${t.timestamp}</td><td>${escapeHtml(t.type)}</td><td>${escapeHtml(t.category||'') + ' ' + escapeHtml(t.name||'')}</td><td>${t.productsAffected? t.productsAffected.map(x=> x.sku + '×' + x.qty).join(', ') : ''}</td><td class="${cls}">${displayAmount}</td><td>${profitCol}</td><td>${escapeHtml(t.note||'')}</td></tr>`;
    });
    html += '</tbody></table>';
    html += `<h2>Orders</h2><table><thead><tr><th>Order#</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th><th>Placed</th><th>Shipping</th></tr></thead><tbody>`;
    state.orders.forEach(o=>{
      const statusCls = (o.status === 'cancelled' || o.status === 'returned') ? 'red' : 'black';
      html += `<tr><td>${o.orderNo}</td><td>${escapeHtml(o.customerName)}</td><td>${o.items.map(it=>escapeHtml(it.sku)+'×'+it.qty).join(', ')}</td><td>${currency(o.total)}</td><td class="${statusCls}">${o.status}</td><td>${o.placedAt}</td><td>${currency(o.shippingCharge||0)}</td></tr>`;
    });
    html += '</tbody></table></body></html>';
    const blob = new Blob([html], {type:'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'gadgetpro_styled_export.html'; a.click(); URL.revokeObjectURL(a.href);
  }

  function exportProductsCSV(){
    const rows = [['sku','name','price','cost','purchased','stock','sold','returned','cancelled']];
    state.products.forEach(p => rows.push([p.sku, p.name, p.price, p.cost, p.purchased||0, p.stock||0, p.sold||0, p.returned||0, p.cancelled||0]));
    const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
    download('products.csv', csv, 'text/csv');
  }

  function csvSafe(s){ if(s === undefined || s === null) return '""'; const str = String(s).replace(/"/g,'""'); return '"' + str + '"'; }

  function download(filename, text, mime='text/csv'){ const blob = new Blob([text], {type:mime}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href); }

  // Import file (JSON full backup or CSV product import)
  function importFile(file){
    const reader = new FileReader();
    reader.onload = (e) => {
      const content = e.target.result;
      if(file.name.endsWith('.json')){
        try{
          const parsed = JSON.parse(content);
          // basic shape validation
          if(parsed.products && parsed.orders && parsed.transactions){
            state = parsed;
            // Ensure resettableFin is present after import
            if (!state.resettableFin) {
                state.resettableFin = {totalSales:0,netProfit:0,netInvestment:0,lastReset:nowISO()};
            }
            // Ensure orders have shippingCharge
             state.orders.forEach(o => {
                if (typeof o.shippingCharge === 'undefined') {
                    o.shippingCharge = 0;
                }
            });
            save(); renderDashboard(); showToast('JSON import successful');
          } else {
            alert('JSON format not recognized (expected products, orders, transactions arrays).');
          }
        } catch(err){ alert('Invalid JSON file.'); }
      } else if(file.name.endsWith('.csv')){
        // simple CSV product import: header includes sku,name,price,cost,stock (flexible)
        const lines = content.split(/\r?\n/).filter(Boolean);
        if(lines.length === 0) { alert('CSV is empty'); return; }
        const headers = lines.shift().split(',').map(h=>h.replace(/"/g,'').trim().toLowerCase());
        lines.forEach(line => {
          const cols = line.split(',').map(c => c.replace(/"/g,'').trim());
          const obj = {}; headers.forEach((h,i)=> obj[h] = cols[i]);
          if(obj.sku){
            // Check if product exists to avoid duplicates on partial import
            if (!state.products.find(p => p.sku === obj.sku)) {
              state.products.push({ id:uid('p'), sku: obj.sku, name: obj.name||'', price: Number(obj.price||0), cost: Number(obj.cost||0), purchased: Number(obj.purchased||0)||0, stock: Number(obj.stock||0)||0, sold:0, returned:0, cancelled:0 });
            }
          }
        });
        save(); renderDashboard(); showToast('Products imported from CSV');
      } else {
        alert('Unsupported file type. Use .json (backup) or .csv (products).');
      }
    };
    reader.readAsText(file);
  }

  // file input hookup
  $('#file-input').addEventListener('change', (e) => {
    const f = e.target.files[0]; if(!f) return;
    importFile(f);
    e.target.value = '';
  });

  // ---------- Open/Close running ----------

  // ---------- Start up: load, bind events, initial render ----------
  load();

  // Bind card click behaviors already set earlier; ensure certain buttons (some are duplicated) are bound properly:
  $('#card-products').onclick = () => openProductsModal();
  $('#card-tx').onclick = () => openTransactionsModal();
  $('#card-investments').onclick = () => openTransactionsModal('investment');


  // Export buttons in header already wired
  $('#btn-export').onclick = ()=> { exportCSV(); exportStyledHTML(); showToast('Exports ready'); };
  $('#btn-import').onclick = ()=> $('#file-input').click();

  // Export CSV small button for inline use
  $('#export-csv').onclick = ()=> exportCSV();
  $('#export-styled').onclick = ()=> { exportStyledHTML(); showToast('Styled export ready'); };

  // initial render
  renderDashboard();

  // safety: ensure modal open functions available on window scope for inline handlers (if needed)
  window.openProductsModal = openProductsModal;
  window.openTransactionsModal = openTransactionsModal;
  window.openOrderViewModal = openOrderViewModal;
  window.openSellModal = openSellModal;
  window.exportCSV = exportCSV;
  window.exportStyledHTML = exportStyledHTML;
  window.exportProductsCSV = exportProductsCSV;

  // keyboard shortcut: ctrl+s download JSON backup
  document.addEventListener('keydown', (ev) => {
    if(ev.ctrlKey && ev.key === 's'){ ev.preventDefault(); download('gadgetpro-backup.json', JSON.stringify(state), 'application/json'); showToast('Backup downloaded'); }
  });

  // End IIFE
})();

</script>
</body>
</html>
